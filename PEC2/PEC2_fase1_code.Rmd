```{r librerias}
library(easyPubMed)
library(pubmed.mineR)
```

Descargando ejemplo filtrado de articulos de endometriosis posteriores a 2019:
```{r batch download, eval=FALSE, echo=TRUE}
query <- "endometriosis AND 2020/01/01:3000/12/31[dp]"

batch_pubmed_download(pubmed_query_string = query,
                      dest_dir = "intermediateData/",
                      dest_file_prefix = "last_endometriosis",
                      format = "abstract",
                      batch_size = 5000
                      )

```

Generando objeto clase 'Abstracts':
```{r ejemplo readbs, eval=FALSE, echo=TRUE}
last_abstracts <- readabs("intermediateData/last_endometriosis01.txt")

save(last_abstracts,
     file = "intermediateData/last_abstracts.RData")
```

Ejemplo extraccion codigos de genes:
```{r ejemplo gene atomization, eval=FALSE, echo=TRUE}
last_genes <- gene_atomization(last_abstracts)

save(last_genes,
     file="intermediateData/last_genes.RData")
```

Ejemplo extraccion de palabras:
```{r word atomizations example, eval=FALSE, echo=TRUE}
last_words <- word_atomizations(last_abstracts)

save(last_words,
     file = "intermediateData/last_words.RData")
```

Ejemplo TDM:
```{r term document matrix example, eval=FALSE, echo=TRUE}
tdm <- tdm_for_lsa(last_abstracts, 
                   c("age", "gender", "woman", "women", " man ", 
                     " men ", "smoking", "relationships", "relation"))

save(tdm,
     file = "intermediateData/last_tdm.RData")
```




Descargando todos los artículos de endometriosis:
```{r download all endometriosis, eval=FALSE}
batch_pubmed_download("endometriosis",
                      dest_dir = "data/",
                      dest_file_prefix = "total_endometriosis",
                      format = "abstract",
                      batch_size = 5000
                      )
```

Una vez tenemos los archivos, concatenamos todos los datos en uno único:
```{r concatenate text files, eval=FALSE}
# List of files to be added together
files_list <- list.files(path = "data/",
                         pattern = "total",
                         full.names = TRUE) # include path
# Create new file
out_file <- file(description = "intermediateData/todos.txt",
                 open = "w")
# Read each downloaded file and write into final file
for (i in files_list){
  x <- readLines(i)
  writeLines(x, out_file)
}

close(out_file)
```

Genera objeto S4 (corpus primario):
```{r generate abstract object, eval=FALSE}
# Generate the object
abstracts <- readabs("intermediateData/todos.txt")
# Save object
save(abstracts, file = "intermediateData/abstracts.RData")
str(abstracts)
```


Word atomization:
```{r word atomization, eval=FALSE}
words <- word_atomizations(abstracts)
save(words, file = "intermediateData/words.RData")
# Move text file to results directory
file.rename(from = "word_table.txt",
            "results/words.txt")
```

Gene extraction:
```{r gene extraction, eval=FALSE}
genes <- gene_atomization(abstracts)
save(genes, file = "intermediateData/genes.RData")
# Move text file to results directory
file.rename(from = "table.txt",
            "results/genes.txt")
```

En qué frases estás los genes sospechosos (AMH en concreto):
```{r, official_fn, eval=FALSE}
# Returns a text file with the sentences that contain official gene symbols from HGNC.
official_fn(genes = genes,
            abs = abstracts,
            filename = "intermediateData/sus.txt",
            terms = "*")

file.rename(from = "intermediateData/sus.txtofficial.txt",
            "results/sus.txtofficial.txt")

# Structure of the output is:
# >> gene_symbol
# PMID
# Sentence
```



